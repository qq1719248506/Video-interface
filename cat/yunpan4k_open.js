import{load,_}from"assets://js/lib/cat.js";import{log}from"./lib/utils.js";import{initAli,detailContent,playContent}from"./lib/ali.js";let siteKey="yunpan4k",siteType=0,siteUrl="https://www.codelicence.cn",patternAli=/(https:\/\/www\.(aliyundrive|alipan)\.com\/s\/[^"]+)/;const UA="Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1";async function requestRaw(reqUrl,method,data,redirect){return await req(reqUrl,{method:method||"get",headers:{"User-Agent":UA,Referer:siteUrl},data:data,postType:"post"===method?"form":"",redirect:0==redirect?0:1})}async function request(reqUrl,method,data){return(await requestRaw(reqUrl,method,data)).content}async function init(cfg){try{siteKey=_.isEmpty(cfg.skey)?"":cfg.skey,siteType=_.isEmpty(cfg.stype)?"":cfg.stype,await initAli(cfg.ext)}catch(e){await log("init:"+e.message+" line:"+e.lineNumber)}}async function home(filter){return"{}"}async function homeVod(){}async function category(tid,pg,filter,extend){return"{}"}async function detail(id){try{var matches=id.match(patternAli);if(!_.isEmpty(matches))return await detailContent(matches[1]);var html=await request(siteUrl+id),href=load(html)("div.down a:first").attr("href"),headers=(await requestRaw(siteUrl+href,"get",null,0)).headers;let url="";return(matches=(url=headers.hasOwnProperty("location")?headers.location:url).match(patternAli),_.isEmpty(matches))?"":await detailContent(matches[1])}catch(e){await log("detail:"+e.message+" line:"+e.lineNumber)}}async function play(flag,id,flags){try{return await playContent(flag,id,flags)}catch(e){await log("play:"+e.message+" line:"+e.lineNumber)}}async function search(wd,quick,pg){pg<=0&&(pg=1);wd={keyboard:wd};let html="";var wd=(await requestRaw(siteUrl+"/search","post",wd)).headers;wd.hasOwnProperty("location")&&(wd=wd.location+"?p="+pg,html=await request(wd));const $=load(html);var wd=$("ul#url"),wd=_.map(wd,item=>{var name,item=$(item),href=item.find("a.l").attr("href");if(href)return name=item.text().trim(),item=item.find("li.r").attr("data_size"),console.debug("vod_id:"+href),{vod_id:href,vod_name:name,vod_pic:"https://pic.rmb.bdstatic.com/bjh/6a2278365c10139b5b03229c2ecfeea4.jpeg",vod_remarks:item}}),nextPage=$(".pages_search .nex:contains(下一页)"),nextPage=!_.isEmpty(nextPage)?parseInt(pg)+1:parseInt(pg);return JSON.stringify({page:parseInt(pg),pagecount:nextPage,limit:20,total:20*nextPage,list:wd.filter(item=>void 0!==item)})}function __jsEvalReturn(){return{init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search}}export{__jsEvalReturn};