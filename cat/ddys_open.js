import{Crypto,load,_}from"assets://js/lib/cat.js";const key="ddys";let DOMAIN="ddys.pro",HOST="https://"+DOMAIN,PLAY_HOST="https://v."+DOMAIN;const FROM_DIRECT="直连",FROM_PARSE="解析";let siteKey="",siteType=0;const UA="Mozilla/5.0 (Linux; Android 11; M2007J3SC Build/RKQ1.200826.002; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/77.0.3865.120 MQQBrowser/6.2 TBS/045714 Mobile Safari/537.36";async function request(reqUrl){return(await req(reqUrl,{method:"get",headers:{Host:HOST.match(/.*\:\/\/(.*)/)[1],"User-Agent":UA,Referer:HOST,"Accept-Encoding":"gzip"}})).content}async function init(cfg){siteKey=cfg.skey,siteType=cfg.stype,cfg.hasOwnProperty("ext")&&cfg.ext.hasOwnProperty("domain")&&(DOMAIN=cfg.ext.domain,HOST="https://"+DOMAIN,PLAY_HOST="https://v."+DOMAIN)}async function home(filter){return JSON.stringify({class:[{type_id:"class",type_name:"类型"},{type_id:"movie",type_name:"电影"},{type_id:"airing",type_name:"热映中"},{type_id:"drama",type_name:"剧集"},{type_id:"anime",type_name:"动画"},{type_id:"documentary",type_name:"纪录片"},{type_id:"variety",type_name:"综艺"}],filters:{class:[{key:"tag",name:"标签",init:"recommend",value:[{n:"站长推荐",v:"recommend"},{n:"动作",v:"action"},{n:"喜剧",v:"comedy"},{n:"爱情",v:"romance"},{n:"科幻",v:"sci-fi"},{n:"犯罪",v:"crime"},{n:"悬疑",v:"mystery"},{n:"恐怖",v:"horror"}]}],movie:[{key:"type",name:"分类",init:"",value:[{n:"全部",v:""},{n:"欧美电影",v:"western-movie"},{n:"日韩电影",v:"asian-movie"},{n:"华语电影",v:"chinese-movie"}]}],drama:[{key:"type",name:"分类",init:"",value:[{n:"全部",v:""},{n:"欧美剧",v:"western-drama"},{n:"日剧",v:"jp-drama"},{n:"韩剧",v:"kr-drama"},{n:"华语剧",v:"cn-drama"},{n:"其他地区",v:"other"}]}],anime:[{key:"type",name:"分类",init:"",value:[{n:"全部",v:""},{n:"本季新番",v:"new-bangumi"}]}]}})}async function homeVod(){}async function category(tid,pg,filter,extend){pg<=0&&(pg=1);let path="",page=(extend.tag?path="/tag/"+extend.tag:(path="/category/"+tid,_.isEmpty(extend.type)||(path+="/"+extend.type)),"");1<pg&&(page="page/"+pg+"/");tid=await request(HOST+path+"/"+page);const $=load(tid);extend=$(".post-box-list article"),tid=_.map(extend,item=>{var item=$(item),title=item.find(".post-box-title a"),name=title.text(),title=title.attr("href"),image=item.find(".post-box-image").attr("style").replace(/.*url\((.*)\);/g,"$1"),item=item.find(".post-box-meta").text();return{vod_id:title.replace(/.*\/\/.*\/(.*)\//g,"$1"),vod_name:name,vod_pic:image,vod_remarks:item||""}}),extend=0<$("nav.navigation a.next").length?parseInt(pg)+1:parseInt(pg);return JSON.stringify({page:parseInt(pg),pagecount:extend,limit:28,total:28*extend,list:tid})}async function detail(id){var html=await request(HOST+"/"+id+"/");const $=load(html);html=$("div.abstract")[0].children,id={vod_id:id,vod_name:$("h1.post-title").text(),vod_type:findAbstractText(html,"类型:"),vod_year:findAbstractText(html,"年份:"),vod_area:findAbstractText(html,"制片国家/地区:"),vod_director:findAbstractText(html,"导演:"),vod_actor:findAbstractText(html,"演员:"),vod_pic:$("div.post img:first").attr("data-cfsrc"),vod_remarks:$("span.cat-links").text().trim(),vod_content:findAbstractText(html,"简介:")};const playMap={};parseAndUpdateUrls($,playMap);var html=$("div.page-links a"),html=(_.isEmpty(html)||(html=_.map(html,link=>{return request($(link).attr("href"))}),html=await Promise.all(html),_.each(html,resp=>{try{parseAndUpdateUrls(load(resp),playMap)}catch(e){}})),id.vod_play_from=_.keys(playMap).join("$$$"),_.values(playMap)),html=_.map(html,urlist=>urlist.join("#"));return id.vod_play_url=html.join("$$$"),JSON.stringify({list:[id]})}function findAbstractText(children,keyword){for(const item of children)if("text"==item.type&&item.data&&item.data.startsWith(keyword))return item.data.substring(keyword.length).trim();return""}function parseAndUpdateUrls($,playMap){$=$("script.wp-playlist-script").text(),$=JSON.parse($).tracks;_.each($,track=>{var title=track.caption,directUrl=track.src0;playMap.hasOwnProperty(FROM_DIRECT)||(playMap[FROM_DIRECT]=[]),playMap[FROM_DIRECT].push(title+"$"+directUrl),_.isEmpty(track.src1)||(playMap.hasOwnProperty(FROM_PARSE)||(playMap[FROM_PARSE]=[]),playMap[FROM_PARSE].push(title+"$"+track.src1))})}async function play(flag,id,flags){let playUrl;playUrl=flag==FROM_PARSE?(flag=await request(HOST+"/getvddr2/video?id="+id+"&type=json"),JSON.parse(flag).url):PLAY_HOST+id;flag={"User-Agent":UA,Referer:HOST,"Icy-MetaData":"1","Sec-Fetch-Site":"same-site","Sec-Fetch-Mode":"cors","Sec-Fetch-Dest":"video"};return JSON.stringify({parse:0,url:playUrl,header:flag})}async function search(wd,quick,pg){let page="";1<pg&&(page="/page/"+pg);wd=await request(HOST+page+"/?s="+wd+"&post_type=post");const $=load(wd);var wd=$("div.post-content"),wd=_.map(wd,item=>{var item=$(item),title=item.find(".post-title a"),name=title.text(),title=title.attr("href"),item=item.find(".cat-links").text();return{vod_id:title.replace(/.*\/\/.*\/(.*)\//g,"$1"),vod_name:name,vod_pic:HOST+"/android-chrome-512x512.png",vod_remarks:item}}),pgCount=0<$("nav.navigation a.next").length?parseInt(pg)+1:parseInt(pg);return JSON.stringify({page:parseInt(pg),pagecount:pgCount,limit:100,total:100*pgCount,list:wd})}function __jsEvalReturn(){return{init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,search:search}}export{__jsEvalReturn};