import{Crypto,jinja2,_}from"assets://js/lib/cat.js";let siteKey="",siteType=0,cookie="",login="",vip=!1,extendObj={},bili_jct="",vod_audio_id={30280:192e3,30232:132e3,30216:64e3},vod_codec={12:"HEVC",7:"AVC"};const UA="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36";async function request(reqUrl,ua,buffer){return(await req(reqUrl,{method:"get",headers:ua||{"User-Agent":UA},timeout:6e4,buffer:buffer?1:0})).content}async function post(reqUrl,postData,ua,posttype){return(await req(reqUrl,{method:"post",headers:ua||{"User-Agent":UA},data:postData,timeout:6e4,postType:posttype})).content}function getHeaders(){var headers={"User-Agent":UA};return _.isEmpty(cookie)||(headers.cookie=cookie),headers}async function getCookie(){var setCookieHeaders=(await req("https://www.bilibili.com",{method:"get",headers:{"User-Agent":UA},timeout:6e4})).headers["set-cookie"];cookie=setCookieHeaders.map(kk=>kk.split(";")[0]+";").join("")}async function init(cfg){siteKey=cfg.skey,siteType=cfg.stype;let extend=cfg.ext;cfg.ext.hasOwnProperty("categories")&&(extend=cfg.ext.categories);(cookie=(cookie=cfg.ext.hasOwnProperty("cookie")?cfg.ext.cookie:cookie).startsWith("http")?await request(cookie):cookie).split(";").forEach(cookie=>{cookie.includes("bili_jct")&&(bili_jct=cookie.split("=")[1])}),_.isEmpty(cookie)&&await getCookie();var cfg=JSON.parse(await request("https://api.bilibili.com/x/web-interface/nav",getHeaders())),cfg=(login=cfg.data.isLogin,vip=cfg.data.vipStatus,extend.split("#")),jsonData=[{key:"order",name:"排序",value:[{n:"综合排序",v:"0"},{n:"最多点击",v:"click"},{n:"最新发布",v:"pubdate"},{n:"最多弹幕",v:"dm"},{n:"最多收藏",v:"stow"}]},{key:"duration",name:"时长",value:[{n:"全部时长",v:"0"},{n:"60分钟以上",v:"4"},{n:"30~60分钟",v:"3"},{n:"10~30分钟",v:"2"},{n:"10分钟以下",v:"1"}]}],newarr=[],d={};newarr.push({type_name:"首页",type_id:"首页",land:1,ratio:1.33});for(const kk of cfg){var c={type_name:kk,type_id:kk,land:1,ratio:1.33};newarr.push(c),d[kk]=jsonData}_.isEmpty(bili_jct)||newarr.push({type_name:"历史记录",type_id:"历史记录",land:1,ratio:1.33}),extendObj={classes:newarr,filter:d}}function home(filter){try{var jSONObject={class:extendObj.classes};return filter&&(jSONObject.filters=extendObj.filter),JSON.stringify(jSONObject)}catch(e){return""}}async function homeVod(){try{var list=[],response=await request("https://api.bilibili.com/x/web-interface/index/top/rcmd?ps=14&fresh_idx=1&fresh_idx_1h=1",getHeaders());for(const item of JSON.parse(response).data.item){var vod={};let imageUrl=item.pic;imageUrl.startsWith("//")&&(imageUrl="https:"+imageUrl);var cd=getFullTime(item.duration);vod.vod_id=item.bvid,vod.vod_name=removeTags(item.title),vod.vod_pic=imageUrl,vod.vod_remarks=cd,vod.style={type:"rect",ratio:1.33},list.push(vod)}var result={list:list};return JSON.stringify(result)}catch(e){}}async function category(tid,page,filter,ext){page<1&&(page=1);try{0<Object.keys(ext).length&&ext.hasOwnProperty("tid")&&0<ext.tid.length&&(tid=ext.tid);let url="";if(url="https://api.bilibili.com/x/web-interface/search/type?search_type=video&keyword="+encodeURIComponent(tid),0<Object.keys(ext).length)for(const k in ext)"tid"!=k&&(url+=`&${encodeURIComponent(k)}=`+encodeURIComponent(ext[k]));url+="&page="+encodeURIComponent(page),"首页"==tid?url="https://api.bilibili.com/x/web-interface/index/top/rcmd?ps=14&fresh_idx="+page+"&fresh_idx_1h="+page:"历史记录"==tid&&(url="https://api.bilibili.com/x/v2/history?pn="+page);var data=JSON.parse(await request(url,getHeaders())).data;let items=data.result;"首页"==tid?items=data.item:"历史记录"==tid&&(items=data);var videos=[];for(const item of items){var video={};let pic=item.pic;pic.startsWith("//")&&(pic="https:"+pic);var cd=getFullTime(item.duration);video.vod_remarks=cd,video.vod_id=item.bvid,video.vod_name=removeTags(item.title),video.vod_pic=pic,video.style={type:"rect",ratio:1.33},videos.push(video)}var result={page:page,pagecount:data.numPages??page+1,limit:videos.length,total:videos.length*(page+1),list:videos};return JSON.stringify(result)}catch(e){}return null}async function detail(ids){try{var bvid=ids,detailUrl="https://api.bilibili.com/x/web-interface/view?bvid="+bvid,detailData=JSON.parse(await request(detailUrl,getHeaders())).data,cd=(_.isEmpty(bili_jct)||await post("https://api.bilibili.com/x/v2/history/report",{aid:detailData.aid,cid:detailData.cid,csrf:bili_jct},getHeaders(),"form"),getFullTime(detailData.duration)),aid=detailData.aid,video={vod_id:bvid,vod_name:detailData.title,vod_pic:detailData.pic,type_name:detailData.tname,vod_year:"",vod_area:"",vod_remarks:cd,vod_actor:"",vod_director:"",vod_content:detailData.desc},playurldata="https://api.bilibili.com/x/player/playurl?avid="+aid+"&cid="+detailData.cid+"&qn=127&fnval=4048&fourk=1",playurldatalist=JSON.parse(await request(playurldata,getHeaders())).data,accept_quality=playurldatalist.accept_quality,accept_description=playurldatalist.accept_description,qualitylist=[],descriptionList=[];for(let i=0;i<accept_quality.length;i++){if(!vip)if(login){if(80<accept_quality[i])continue}else if(32<accept_quality[i])continue;descriptionList.push(base64Encode(accept_description[i])),qualitylist.push(accept_quality[i])}var treeMap={},jSONArray=detailData.pages;let playList=[];for(let j=0;j<jSONArray.length;j++){var cid=jSONArray[j].cid,playUrl=j+"$"+aid+"+"+cid+"+"+qualitylist.join(":")+"+"+descriptionList.join(":");playList.push(playUrl)}treeMap.dash=playList.join("#"),treeMap.mp4=playList.join("#");var relatedUrl="https://api.bilibili.com/x/web-interface/archive/related?bvid="+bvid,relatedData=JSON.parse(await request(relatedUrl,getHeaders())).data;playList=[];for(let j=0;j<relatedData.length;j++){const jSONObject6=relatedData[j],cid=jSONObject6.cid;const playUrl=jSONObject6.title+"$"+jSONObject6.aid+"+"+cid+"+"+qualitylist.join(":")+"+"+descriptionList.join(":");playList.push(playUrl)}treeMap["相关"]=playList.join("#"),video.vod_play_from=Object.keys(treeMap).join("$$$"),video.vod_play_url=Object.values(treeMap).join("$$$");var result={list:[video]};return JSON.stringify(result)}catch(e){}return null}async function play(flag,id,flags){try{var playHeaders={Referer:"https://www.bilibili.com","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36"},ids=id.split("+"),aid=ids[0],cid=ids[1],qualityIds=ids[2].split(":"),qualityName=ids[3].split(":");if("dash"==flag||"相关"==flag){var js2Base=await js2Proxy(!0,siteType,siteKey,"dash/",{}),urls=[];for(let i=0;i<qualityIds.length;i++)urls.push(base64Decode(qualityName[i]),js2Base+base64Encode(aid+"+"+cid+"+"+qualityIds[i]));return JSON.stringify({parse:0,url:urls,header:playHeaders})}if("mp4"==flag){let urls=[];for(let i=0;i<qualityIds.length;i++){var durl,url=`https://api.bilibili.com/x/player/playurl?avid=${aid}&cid=${cid}&qn=${qualityIds[i]}&fourk=1`,data=JSON.parse(await request(url,getHeaders())).data;data.quality==qualityIds[i]&&(durl=data.durl[0].url,urls.push(base64Decode(qualityName[i]),durl))}return JSON.stringify({parse:0,url:urls,header:playHeaders})}{let urls=[],audios=[];for(let i=0;i<qualityIds.length;i++){const url=`https://api.bilibili.com/x/player/playurl?avid=${aid}&cid=${cid}&qn=${qualityIds[i]}&fnval=4048&fourk=1`;let resp=JSON.parse(await request(url,getHeaders()));var dash=resp.data.dash,video=dash.video,audio=dash.audio;for(let j=0;j<video.length;j++){var dashjson=video[j];if(dashjson.id==qualityIds[i])for(const key in vod_codec)dashjson.codecid==key&&urls.push(base64Decode(qualityName[i])+" "+vod_codec[key],dashjson.baseUrl)}if(0==audios.length){for(let j=0;j<audio.length;j++){const dashjson=audio[j];for(const key in vod_audio_id)dashjson.id==key&&audios.push({title:_.floor(parseInt(vod_audio_id[key])/1024)+"Kbps",bit:vod_audio_id[key],url:dashjson.baseUrl})}audios=_.sortBy(audios,"bit")}}return JSON.stringify({parse:0,url:urls,extra:{audio:audios},header:playHeaders})}}catch(e){}return null}async function search(key,quick,pg){let page=pg||1;0==page&&(page=1);try{var ext={duration:"0"},resp=JSON.parse(await category(key,page,!0,ext)),catVideos=resp.list,pageCount=resp.pagecount,videos=[];for(let i=0;i<catVideos.length;++i)videos.push(catVideos[i]);var result={page:page,pagecount:pageCount,land:1,ratio:1.33,list:videos};return JSON.stringify(result)}catch(e){}return null}async function proxy(segments,headers){var what=segments[0],segments=base64Decode(segments[1]);if("dash"!=what)return JSON.stringify({code:500,content:""});{var what=segments.split("+"),segments=what[0],cid=what[1],str5=what[2];let videoList="",audioList="";var what=JSON.parse(await request(`https://api.bilibili.com/x/player/playurl?avid=${segments}&cid=${cid}&qn=${str5}&fnval=4048&fourk=1`,getHeaders())),segments=what.data.dash,video=segments.video,audio=segments.audio;for(let i=0;i<video.length;i++){var dashjson=video[i];dashjson.id==str5&&(videoList+=getDashMedia(dashjson))}for(let i=0;i<audio.length;i++){var ajson=audio[i];for(const key in vod_audio_id)ajson.id==key&&(audioList+=getDashMedia(ajson))}cid=getDash(what,videoList,audioList);return JSON.stringify({code:200,content:cid,headers:{"Content-Type":"application/dash+xml"}})}}function getDashMedia(dash){try{let qnid=dash.id;var audioSamplingRate,codecid=dash.codecid,media_codecs=dash.codecs,media_bandwidth=dash.bandwidth,media_startWithSAP=dash.startWithSap,media_mimeType=dash.mimeType,media_BaseURL=dash.baseUrl.replace(/&/g,"&amp;"),media_SegmentBase_indexRange=dash.SegmentBase.indexRange,media_SegmentBase_Initialization=dash.SegmentBase.Initialization,mediaType=media_mimeType.split("/")[0];let media_type_params="";if("video"==mediaType){var media_frameRate=dash.frameRate,media_sar=dash.sar,media_width=dash.width,media_height=dash.height;media_type_params=`height='${media_height}' width='${media_width}' frameRate='${media_frameRate}' sar='${media_sar}'`}else if("audio"==mediaType)for(const key in vod_audio_id)qnid==key&&(audioSamplingRate=vod_audio_id[key],media_type_params=`numChannels='2' sampleRate='${audioSamplingRate}'`);return`<AdaptationSet lang="chi">
        <ContentComponent contentType="${mediaType}"/>
        <Representation id="${qnid+="_"+codecid}" bandwidth="${media_bandwidth}" codecs="${media_codecs}" mimeType="${media_mimeType}" ${media_type_params} startWithSAP="${media_startWithSAP}">
          <BaseURL>${media_BaseURL}</BaseURL>
          <SegmentBase indexRange="${media_SegmentBase_indexRange}">
            <Initialization range="${media_SegmentBase_Initialization}"/>
          </SegmentBase>
        </Representation>
      </AdaptationSet>`}catch(e){}}function getDash(ja,videoList,audioList){var duration=ja.data.dash.duration;return`<MPD xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="urn:mpeg:dash:schema:mpd:2011" xsi:schemaLocation="urn:mpeg:dash:schema:mpd:2011 DASH-MPD.xsd" type="static" mediaPresentationDuration="PT${duration}S" minBufferTime="PT${ja.data.dash.minBufferTime}S" profiles="urn:mpeg:dash:profile:isoff-on-demand:2011">
      <Period duration="PT${duration}S" start="PT0S">
        ${videoList}
        ${audioList}
      </Period>
    </MPD>`}function base64Encode(text){return Crypto.enc.Base64.stringify(Crypto.enc.Utf8.parse(text))}function base64Decode(text){return Crypto.enc.Utf8.stringify(Crypto.enc.Base64.parse(text))}function removeTags(input){return input.replace(/<[^>]*>/g,"")}function getFullTime(numberSec){let totalSeconds="";try{var timeParts=numberSec.split(":"),min=parseInt(timeParts[0]),sec=parseInt(timeParts[1]);totalSeconds=60*min+sec}catch(e){totalSeconds=parseInt(numberSec)}if(isNaN(totalSeconds))return"无效输入";if(3600<=totalSeconds)return timeParts=Math.floor(totalSeconds/3600),min=totalSeconds%3600,timeParts+`小时 ${Math.floor(min/60)}分钟 ${min%60}秒`;{const minutes=Math.floor(totalSeconds/60),seconds=totalSeconds%60;return`${minutes}分钟 ${seconds}秒`}}function __jsEvalReturn(){return{init:init,home:home,homeVod:homeVod,category:category,detail:detail,play:play,proxy:proxy,search:search}}export{__jsEvalReturn};